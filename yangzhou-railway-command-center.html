<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>扬州市域铁路智慧指挥中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入地图库 Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- 字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- 图标 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-cyan: #06b6d4;
            --primary-blue: #3b82f6;
            --accent-gold: #fbbf24;
            --bg-dark: #050b14;
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-bg: rgba(13, 24, 41, 0.85);
            --card-gradient: linear-gradient(135deg, rgba(6,182,212,0.1) 0%, rgba(59,130,246,0.05) 100%);
        }

        body {
            background-color: var(--bg-dark);
            font-family: "Noto Sans SC", "Microsoft YaHei", sans-serif;
            overflow: hidden;
            color: #e2e8f0;
            margin: 0;
            height: 100vh;
        }

        .font-tech { font-family: 'Orbitron', sans-serif; }

        /* 玻璃拟态面板 */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        }

        .scanlines {
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 3px;
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 5;
            opacity: 0.3;
        }

        /* === 核心修复：视差与翻转架构分离 === */
        
        /* 1. 视差容器 (Tilt Container) - 负责跟随鼠标倾斜 */
        .tilt-wrapper {
            perspective: 1500px; /* 增加透视距离，减少畸变 */
            transform-style: preserve-3d;
            height: calc(100vh - 180px); 
            max-height: 580px;
            min-height: 480px;
            /* 关键：这里的 transform 会由 JS 动态控制 */
        }

        /* 2. 翻转容器 (Flip Wrapper) - 负责点击旋转 180度 */
        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            /* 贝塞尔曲线：丝滑回弹效果 */
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-style: preserve-3d;
        }

        /* 激活翻转状态 */
        .flip-card-inner.flipped {
            transform: rotateY(180deg);
        }

        /* 3. 正反面公共样式 */
        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* 关键：隐藏背面 */
            backface-visibility: hidden;
            border-radius: 1rem;
            overflow: hidden;
            background: var(--card-gradient);
            display: flex;
            flex-direction: column;
            top: 0; 
            left: 0;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.1);
        }

        .flip-card-back {
            transform: rotateY(180deg);
            background: rgba(8, 14, 28, 0.98);
            border: 1px solid var(--primary-cyan);
        }

        /* 交互提示动画 */
        .click-hint {
            animation: pulse-ring 2s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4); }
            70% { box-shadow: 0 0 0 8px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }

        /* 表格与滚动条 */
        .control-point-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .control-point-table th { text-align: left; color: var(--primary-cyan); padding: 8px 4px; border-bottom: 1px solid rgba(6, 182, 212, 0.3); }
        .control-point-table td { padding: 6px 4px; color: #cbd5e1; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .geo-layer-tag {
            background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
            border-left: 3px solid; padding: 6px 10px; font-size: 12px;
            display: flex; align-items: center; justify-content: space-between; border-radius: 0 4px 4px 0;
        }

        .custom-scroll { overflow-y: auto; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--primary-cyan); border-radius: 4px; }

        .leaflet-container { background: #000 !important; }
        .text-glow-cyan { text-shadow: 0 0 8px rgba(6, 182, 212, 0.6); }
    </style>
</head>
<body class="selection:bg-cyan-500 selection:text-white">

    <div class="scanlines"></div>
    <div class="absolute inset-0 pointer-events-none z-10 bg-[radial-gradient(circle_at_center,transparent_0%,rgba(0,0,0,0.7)_100%)]"></div>

    <!-- 地图层 -->
    <div id="map" class="absolute inset-0 z-0"></div>

    <!-- 顶部标题栏 -->
    <header class="absolute top-0 left-0 w-full z-20 p-5 flex justify-between items-start bg-gradient-to-b from-black/90 via-black/50 to-transparent pointer-events-none">
        <div class="flex items-center gap-4 pointer-events-auto group">
            <div class="h-10 w-1.5 bg-cyan-500 shadow-[0_0_20px_#06b6d4]"></div>
            <div>
                <!-- 修改点：去南京化，改为扬州市域铁路 -->
                <h1 class="text-2xl font-black tracking-widest text-white font-tech text-glow-cyan">扬州市域铁路智慧指挥中心</h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="px-2 py-0.5 bg-cyan-900/50 border border-cyan-500/30 rounded text-[10px] text-cyan-300">扬州段</span>
                    <p class="text-xs text-gray-300 tracking-wider">扬州至仪征线市域（郊）铁路工程</p>
                </div>
            </div>
        </div>
        <div class="flex flex-col items-end gap-1 font-tech pointer-events-auto">
            <div class="flex items-center gap-3 bg-black/40 px-3 py-1.5 rounded-full border border-white/10 backdrop-blur-sm">
                <div class="text-right">
                    <div id="clock" class="text-lg font-bold text-white leading-none">00:00:00</div>
                    <div class="text-[10px] text-gray-400 text-right">实时数据</div>
                </div>
            </div>
            <button id="back-to-gis-btn" class="mt-1 px-3 py-1 rounded-full border border-cyan-500/50 bg-cyan-900/20 text-cyan-300 text-[10px] hover:bg-cyan-500 hover:text-white transition-all flex items-center gap-1 pointer-events-auto" onclick="goBackToGIS()">
                <i class="fas fa-arrow-left"></i> 返回平台
            </button>
        </div>
    </header>

    <!-- 左侧数据面板 -->
    <aside class="absolute top-24 left-6 w-72 z-20 flex flex-col gap-4 pointer-events-none">
        
        <!-- 总体概况卡 -->
        <div class="glass-panel p-5 rounded-xl pointer-events-auto border-t-4 border-t-cyan-500">
            <h3 class="text-cyan-400 text-sm font-bold mb-3 flex items-center justify-between">
                <span><i class="fas fa-map-marked-alt mr-2"></i>施工区段总控</span>
                <span class="text-[10px] bg-emerald-500/20 px-2 py-0.5 rounded text-emerald-400">施工中</span>
            </h3>
            
            <div class="flex items-end justify-between mb-2">
                <div>
                    <div class="text-xs text-gray-400">当前激活工区</div>
                    <div id="current-zone-display" class="text-3xl font-black text-white font-tech text-glow-cyan mt-1">01</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-400">地理特征</div>
                    <div id="geo-type-display" class="text-xs font-bold text-white mt-1 bg-white/10 px-2 py-1 rounded inline-block">长江漫滩平原</div>
                </div>
            </div>

            <div class="mt-4">
                <div class="flex justify-between text-xs text-gray-300 mb-2">
                    <span>总体进度</span>
                    <span id="total-progress-text" class="text-cyan-400 font-tech">32%</span>
                </div>
                <div class="w-full bg-gray-800 h-1.5 rounded-full overflow-hidden border border-white/5">
                    <div id="total-progress-bar" class="bg-gradient-to-r from-cyan-600 via-cyan-400 to-white h-full w-[32%] relative"></div>
                </div>
            </div>
        </div>

        <!-- 地理水文环境监测 -->
        <div class="glass-panel p-5 rounded-xl pointer-events-auto">
            <h3 class="text-accent-gold text-sm font-bold mb-3 flex items-center">
                <i class="fas fa-layer-group mr-2"></i> 地理水文环境
            </h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>地面高程 (m)</span>
                        <span id="elevation-val" class="text-white font-tech">5.15 ~ 6.33</span>
                    </div>
                    <div class="flex h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                         <div id="elevation-bar" class="bg-yellow-500 h-full transition-all duration-500" style="width: 50%"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                        <span>地下水位埋深 (m)</span>
                        <span id="water-val" class="text-white font-tech">0.75 ~ 3.70</span>
                    </div>
                    <div class="flex h-1.5 w-full bg-gray-800 rounded-full overflow-hidden">
                        <div id="water-bar" class="bg-blue-500 h-full transition-all duration-500" style="width: 30%"></div>
                    </div>
                </div>
                
                <div class="flex items-start gap-2 mt-2 pt-2 border-t border-white/10">
                    <i class="fas fa-info-circle text-gray-500 text-xs mt-0.5"></i>
                    <p id="geo-desc" class="text-[10px] text-gray-400 leading-tight">潜水水位受季节影响明显，需加强监测。</p>
                </div>
            </div>
        </div>

    </aside>

    <!-- 右侧动态信息卡片 (视差 + 丝滑翻转) -->
    <aside class="absolute top-24 right-6 w-[400px] z-20 pointer-events-none">
        
        <!-- 
           架构分离：
           1. tilt-wrapper: 处理鼠标跟随视差 (Tilt)
           2. flip-card-inner: 处理点击翻转 (Flip)
           这样两个 transform 不会打架
        -->
        <div id="tilt-container" class="tilt-wrapper w-full pointer-events-auto cursor-pointer group">
            
            <div id="info-card-inner" class="flip-card-inner">
                
                <!-- 正面：工程概况 -->
                <div class="flip-card-front glass-panel rounded-xl p-6 border-b-4 border-b-blue-500">
                    <div class="absolute top-4 right-4 opacity-20 text-white transform translate-z-10">
                         <i class="fas fa-project-diagram text-6xl"></i>
                    </div>

                    <div class="relative z-20 flex flex-col gap-1 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="px-2 py-0.5 bg-blue-900/40 border border-blue-500/30 rounded text-[10px] text-blue-300">工区详情</span>
                            <div class="flex gap-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span>
                                <span class="w-1.5 h-1.5 rounded-full bg-gray-600"></span>
                            </div>
                        </div>
                        <h2 id="card-zone-title" class="text-3xl font-black text-white tracking-wide mt-2">01工区</h2>
                        <div class="flex items-center gap-1.5 text-cyan-300">
                            <i class="fas fa-map-pin text-xs"></i>
                            <p id="card-location" class="text-sm font-medium">仪征万年路 - 工农路</p>
                        </div>
                    </div>
                    
                    <div class="flex-1 custom-scroll space-y-4 pr-1 relative z-20">
                        <div class="bg-white/5 p-3 rounded border-l-2 border-white/20">
                            <p class="text-xs text-gray-400 mb-1 font-bold">工程范围</p>
                            <p id="card-scope" class="text-xs text-gray-200 leading-relaxed text-justify">包含车站及区间土建施工。</p>
                        </div>

                        <div id="dynamic-info-block">
                            <p class="text-xs text-gray-400 mb-2 font-bold flex items-center justify-between">
                                <span id="dynamic-info-title">关键控制数据</span>
                                <i class="fas fa-crosshairs text-cyan-500 text-[10px]"></i>
                            </p>
                            <div id="dynamic-info-content" class="grid grid-cols-2 gap-2"></div>
                        </div>

                        <div>
                            <p class="text-xs text-gray-400 mb-2 font-bold">地质构造切片</p>
                            <div id="card-geo-layer" class="grid grid-cols-2 gap-2"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-white/10 flex items-center justify-between relative z-20">
                        <span class="text-[10px] text-gray-500">点击卡片任意位置翻转查看详细数据</span>
                        <div class="click-hint w-6 h-6 rounded-full border border-cyan-500 flex items-center justify-center bg-cyan-900/50">
                            <i class="fas fa-sync-alt text-cyan-400 text-[10px]"></i>
                        </div>
                    </div>
                </div>

                <!-- 背面：精密数据表 -->
                <div class="flip-card-back glass-panel rounded-xl p-6">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-cyan-500/30 shrink-0 z-20 relative">
                        <div>
                            <h3 class="text-lg font-bold text-white">精密测量控制网</h3>
                            <p class="text-[10px] text-cyan-400 opacity-80">独立坐标系 / 1985国家高程</p>
                        </div>
                        <div class="w-8 h-8 rounded bg-cyan-900/30 flex items-center justify-center border border-cyan-500 text-cyan-400">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                    </div>

                    <div class="flex-1 overflow-hidden flex flex-col min-h-0 z-20 relative">
                        <div class="custom-scroll flex-1 pr-1">
                            <div class="mb-4">
                                <div class="text-xs text-gray-300 mb-2 pl-1 border-l-2 border-cyan-500 font-bold">平面控制点 (导线点)</div>
                                <table class="control-point-table">
                                    <thead>
                                        <tr>
                                            <th width="20%">点号</th>
                                            <th width="25%">X坐标</th>
                                            <th width="25%">Y坐标</th>
                                            <th width="30%">位置/备注</th>
                                        </tr>
                                    </thead>
                                    <tbody id="control-points-body"></tbody>
                                </table>
                            </div>

                            <div>
                                <div class="text-xs text-gray-300 mb-2 pl-1 border-l-2 border-yellow-500 font-bold">高程控制点 (水准点)</div>
                                <div id="level-points-list" class="grid grid-cols-1 gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-2 border-t border-white/10 shrink-0 flex justify-center z-20 relative">
                        <button id="flip-back-btn" class="px-6 py-1.5 rounded-full border border-cyan-500/50 bg-cyan-900/20 text-cyan-300 text-xs hover:bg-cyan-500 hover:text-white transition-all flex items-center gap-2">
                            <i class="fas fa-undo"></i> 返回概览
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-2 flex justify-end items-center gap-2 pr-2 opacity-70">
            <span class="text-[10px] text-gray-400">数据来源: 实施性施工组织设计</span>
            <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
        </div>
    </aside>

    <!-- 底部控制栏 -->
    <div class="absolute bottom-10 left-1/2 transform -translate-x-1/2 w-[90%] max-w-4xl z-20 pointer-events-auto">
        <div class="glass-panel px-8 py-5 rounded-full flex items-center gap-6 relative overflow-hidden">
            <!-- 修改点：起点改为仪征，去南京化 -->
            <div class="flex flex-col items-end gap-0.5 w-24 flex-shrink-0">
                <span class="text-sm font-bold text-white">仪征</span>
                <span class="text-[10px] text-gray-400">万年路站</span>
            </div>
            
            <div class="relative flex-1 group">
                <div class="absolute top-1/2 w-full flex justify-between px-0.5 pointer-events-none transform -translate-y-1/2 text-[10px] text-gray-500 opacity-60">
                    <div class="flex flex-col items-center gap-1"><span class="h-1.5 w-[1px] bg-gray-400"></span><span class="scale-75">01</span></div>
                    <span class="h-1 w-[1px] bg-gray-600"></span>
                    <span class="h-1 w-[1px] bg-gray-600"></span>
                    <div class="flex flex-col items-center gap-1"><span class="h-1.5 w-[1px] bg-cyan-500"></span><span class="scale-75 text-cyan-500">02</span></div>
                    <span class="h-1 w-[1px] bg-gray-600"></span>
                    <span class="h-1 w-[1px] bg-gray-600"></span>
                    <div class="flex flex-col items-center gap-1"><span class="h-1.5 w-[1px] bg-gray-400"></span><span class="scale-75">06</span></div>
                </div>
                
                <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-700 -translate-y-1/2 rounded-full"></div>
                
                <input type="range" min="0" max="100" value="0" id="progress-slider" class="relative z-10 w-full opacity-0 cursor-pointer h-8">
                
                <div id="slider-thumb" class="absolute top-1/2 -translate-y-1/2 w-6 h-6 bg-bg-dark border-2 border-cyan-400 rounded-full shadow-[0_0_10px_#06b6d4] pointer-events-none transition-transform duration-75 flex items-center justify-center z-20" style="left: 0%">
                    <div class="w-2 h-2 bg-white rounded-full"></div>
                </div>
                
                <div id="slider-fill" class="absolute top-1/2 left-0 h-1 bg-gradient-to-r from-cyan-600 to-cyan-400 -translate-y-1/2 rounded-full pointer-events-none" style="width: 0%"></div>
            </div>

            <!-- 修改点：终点为扬州西 -->
            <div class="flex flex-col items-start gap-0.5 w-24 flex-shrink-0">
                <span class="text-sm font-bold text-white">扬州</span>
                <span class="text-[10px] text-gray-400">西站</span>
            </div>
        </div>
    </div>

    <script>
        const zoneData = [
            {
                id: '01',
                range: [0, 33],
                title: "01工区",
                location: "仪征万年路 - 工农路", // 去南京化
                geoType: "长江漫滩平原",
                geoDesc: "地层主要为淤泥质粉质黏土，具有高灵敏度、高压缩性特点。",
                elevation: "4.20 ~ 10.20", 
                waterLevel: "1.20 ~ 3.80",
                geoLayers: [
                    { name: "杂填土", color: "border-gray-500 text-gray-300" },
                    { name: "淤泥质粉质黏土", color: "border-yellow-700 text-yellow-200" },
                    { name: "粉质黏土", color: "border-yellow-600 text-yellow-100" },
                    { name: "泥岩 (中风化)", color: "border-stone-500 text-stone-300" }
                ],
                hasPreciseCoords: false, 
                dynamicInfo: [
                    { label: "智慧工地", value: "视频监控全覆盖" },
                    { label: "实名制", value: "人脸识别通道" },
                    { label: "扬尘监测", value: "PM2.5/10 联动" },
                    { label: "平台对接", value: "扬州市监管平台" }
                ],
                alternativeTable: [
                    { type: "监测项目", name: "深基坑水平位移", loc: "车站主体基坑", note: "一级监测点" },
                    { type: "监测项目", name: "周边地表沉降", loc: "万年路沿线", note: "±2mm预警" },
                    { type: "监测项目", name: "地下水位监测", loc: "基坑外观测孔", note: "每日一测" },
                    { type: "施工重点", name: "下穿仪城河", loc: "DK24+XXX", note: "防渗漏特级" }
                ],
                levelPoints: [
                    { id: "基准点A1", h: "4.502m (原始基准)" },
                    { id: "基准点A2", h: "4.891m (校核基准)" }
                ]
            },
            {
                id: '02',
                range: [33, 66],
                title: "02工区",
                location: "仪征天宁大道 - 开发区", // 明确为仪征
                geoType: "长江漫滩平原",
                geoDesc: "地势平坦，沿真州东路敷设，穿越多条市政管线。",
                elevation: "4.92 ~ 10.20",
                waterLevel: "0.75 ~ 3.70",
                geoLayers: [
                    { name: "杂填土", color: "border-gray-500 text-gray-300" },
                    { name: "粉砂", color: "border-orange-300 text-orange-100" },
                    { name: "粉质黏土", color: "border-yellow-600 text-yellow-100" },
                    { name: "泥质粉砂岩", color: "border-red-900 text-red-200" }
                ],
                hasPreciseCoords: true,
                dynamicInfo: [
                    { label: "X坐标范围", value: "3573062 - 3788" },
                    { label: "Y坐标范围", value: "502349 - 5949" },
                    { label: "导线点数", value: "6 个一级点" },
                    { label: "测量等级", value: "精密导线网" }
                ],
                controlPoints: [
                    { id: "DTNY-90", x: "3573062.096", y: "502349.962", loc: "汉密尔顿酒店" },
                    { id: "DTNY-35", x: "3573497.033", y: "502690.270", loc: "万博社区" },
                    { id: "DTNY-96", x: "3573412.626", y: "504055.624", loc: "玖龙天街" },
                    { id: "DTNY-20", x: "3573497.035", y: "505179.049", loc: "宝能睿城" },
                    { id: "DTNY-36", x: "3573788.724", y: "505949.471", loc: "真州东路" }
                ],
                levelPoints: [
                    { id: "DTS5-26", h: "9.4407m (国家电网)" },
                    { id: "DTS5-25", h: "10.3992m (红叶社区)" },
                    { id: "DTS5-24", h: "5.7964m (全季酒店)" },
                    { id: "DTS5-23", h: "5.8820m (仪征汽车站)" }
                ]
            },
            {
                id: '06',
                range: [66, 100],
                title: "06工区",
                location: "扬州站南路 - 西站", // 明确为扬州
                geoType: "长江漫滩平原及岗地",
                geoDesc: "扬州西站为岗地地形，地势起伏较大 (11m-27m)。",
                elevation: "4.87 ~ 27.00",
                waterLevel: "0.40 ~ 3.80",
                geoLayers: [
                    { name: "粉土", color: "border-yellow-200 text-yellow-50" },
                    { name: "粉砂夹粉土", color: "border-orange-200 text-orange-50" },
                    { name: "圆砾", color: "border-stone-600 text-stone-200" },
                    { name: "泥质粉砂岩", color: "border-red-900 text-red-200" }
                ],
                hasPreciseCoords: true,
                dynamicInfo: [
                    { label: "X坐标范围", value: "3583037 - 5040" },
                    { label: "Y坐标范围", value: "518450 - 9116" },
                    { label: "关键位置", value: "扬州火车站" },
                    { label: "地形特征", value: "起伏较大" }
                ],
                controlPoints: [
                    { id: "DTNY-12", x: "3585040.752", y: "518860.669", loc: "文昌西路" },
                    { id: "DTNY-67", x: "3584922.250", y: "518450.789", loc: "扬州西站" },
                    { id: "DTNY-98", x: "3584260.339", y: "518580.081", loc: "金地酩悦" },
                    { id: "DTNY-88", x: "3583037.463", y: "519116.885", loc: "湖滨名都" }
                ],
                levelPoints: [
                    { id: "DTS5-1", h: "17.4547m (扬州火车站)" },
                    { id: "DTNY-18", h: "7.5373m (栖祥路)" },
                    { id: "DTNY-41", h: "8.1734m (蒋王路)" }
                ]
            }
        ];

        let map, routeLine, currentMarker, currentZoneIndex = -1;

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initClock();
            initSlider();
            initCardInteraction(); 
            updateDashboard(0);
        });

        function initCardInteraction() {
            const container = document.getElementById('tilt-container');
            const inner = document.getElementById('info-card-inner');
            const backBtn = document.getElementById('flip-back-btn');

            // 1. 视差效果 (Tilt) - 仅当鼠标移动时
            container.addEventListener('mousemove', (e) => {
                // 如果已经翻转，为了体验，暂停视差或减弱
                if (inner.classList.contains('flipped')) return;

                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const xPct = (x / rect.width) - 0.5;
                const yPct = (y / rect.height) - 0.5;

                const rotateY = xPct * 15; 
                const rotateX = -yPct * 15;

                // 直接应用到容器，不影响 inner 的 rotateY(180)
                container.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
            });

            container.addEventListener('mouseleave', () => {
                container.style.transform = `rotateX(0deg) rotateY(0deg)`;
            });

            // 2. 点击翻转
            container.addEventListener('click', (e) => {
                inner.classList.toggle('flipped');
                // 翻转时复位视差，避免视觉混乱
                container.style.transform = `rotateX(0deg) rotateY(0deg)`;
            });

            backBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                inner.classList.remove('flipped');
            });
        }

        function initMap() {
            map = L.map('map', {
                zoomControl: false, attributionControl: false, dragging: false, scrollWheelZoom: false, doubleClickZoom: false
            }).setView([32.33, 119.28], 11);

            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);
            L.rectangle([[31.0, 118.0], [33.0, 120.0]], {color: 'transparent', fillColor: '#050b14', fillOpacity: 0.5}).addTo(map);

            const pathCoords = [
                [32.268, 119.160], // 01: 仪征万年路
                [32.275, 119.185], 
                [32.283, 119.205], // 02: 仪征东
                [32.385, 119.390], 
                [32.396, 119.395]  // 06: 扬州西
            ];

            routeLine = L.polyline(pathCoords, { color: '#06b6d4', weight: 4, opacity: 0.8, dashArray: '10, 15' }).addTo(map);
            L.polyline(pathCoords, { color: '#3b82f6', weight: 12, opacity: 0.2 }).addTo(map);

            pathCoords.forEach(coord => L.circleMarker(coord, { radius: 3, color: '#fff', fillColor: '#06b6d4', fillOpacity: 1 }).addTo(map));

            const iconHtml = `<div class="relative w-8 h-8 flex items-center justify-center"><div class="absolute w-full h-full border-2 border-cyan-500 rounded-full animate-ping opacity-75"></div><div class="absolute w-4 h-4 bg-white rounded-full shadow-[0_0_15px_#fff]"></div></div>`;
            currentMarker = L.marker(pathCoords[0], {icon: L.divIcon({html: iconHtml, className: 'bg-transparent', iconSize: [32, 32], iconAnchor: [16, 16]})}).addTo(map);
        }

        function initSlider() {
            const slider = document.getElementById('progress-slider');
            const thumb = document.getElementById('slider-thumb');
            const fill = document.getElementById('slider-fill');
            slider.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                thumb.style.left = val + '%';
                fill.style.width = val + '%';
                updateMapMarkerPosition(val);
                updateDashboard(val);
            });
        }

        function updateMapMarkerPosition(percent) {
            const points = routeLine.getLatLngs();
            const totalLength = points.length - 1;
            const segmentSize = 100 / totalLength;
            const segmentIndex = Math.floor(percent / segmentSize);
            const segmentPercent = (percent % segmentSize) / segmentSize;
            if (segmentIndex >= totalLength) { currentMarker.setLatLng(points[totalLength]); return; }
            const p1 = points[segmentIndex], p2 = points[segmentIndex + 1];
            currentMarker.setLatLng(L.latLng(p1.lat + (p2.lat - p1.lat) * segmentPercent, p1.lng + (p2.lng - p1.lng) * segmentPercent));
            map.panTo(currentMarker.getLatLng(), {animate: true, duration: 0.5});
        }

        function updateDashboard(val) {
            let activeZone = zoneData[0];
            if (val > 33 && val <= 66) activeZone = zoneData[1];
            if (val > 66) activeZone = zoneData[2];

            if (zoneData.indexOf(activeZone) !== currentZoneIndex) {
                currentZoneIndex = zoneData.indexOf(activeZone);
                renderZoneCard(activeZone);
                // 切换工区时自动翻回正面，并重置视差
                const inner = document.getElementById('info-card-inner');
                const container = document.getElementById('tilt-container');
                inner.classList.remove('flipped');
                container.style.transform = `rotateX(0deg) rotateY(0deg)`;
            }

            document.getElementById('total-progress-text').innerText = parseInt(val) + '%';
            document.getElementById('total-progress-bar').style.width = val + '%';
        }

        function renderZoneCard(data) {
            document.getElementById('current-zone-display').innerText = data.id;
            document.getElementById('geo-type-display').innerText = data.geoType;
            document.getElementById('elevation-val').innerText = data.elevation;
            document.getElementById('water-val').innerText = data.waterLevel;
            document.getElementById('geo-desc').innerText = data.geoDesc;
            
            const avgEle = parseFloat(data.elevation.split('~')[1]) || 10;
            const avgWater = parseFloat(data.waterLevel.split('~')[1]) || 3;
            document.getElementById('elevation-bar').style.width = Math.min((avgEle / 27) * 100, 100) + '%';
            document.getElementById('water-bar').style.width = Math.min((avgWater / 5) * 100, 100) + '%';

            document.getElementById('card-zone-title').innerText = data.title;
            document.getElementById('card-location').innerText = data.location;
            document.getElementById('card-scope').innerText = data.geoDesc + " " + (data.hasPreciseCoords ? "施工区域具备精密控制网。" : "重点进行智慧工地建设。");

            const dynamicContainer = document.getElementById('dynamic-info-content');
            dynamicContainer.innerHTML = '';
            document.getElementById('dynamic-info-title').innerText = data.hasPreciseCoords ? "区域控制概览" : "智慧工地 / 施工重点";
            
            data.dynamicInfo.forEach(item => {
                const div = document.createElement('div');
                div.className = "bg-white/5 p-2 rounded border border-white/10 flex flex-col justify-center";
                div.innerHTML = `<span class="text-[10px] text-gray-500 mb-0.5">${item.label}</span><span class="text-xs text-cyan-400 font-bold truncate">${item.value}</span>`;
                dynamicContainer.appendChild(div);
            });

            const layerList = document.getElementById('card-geo-layer');
            layerList.innerHTML = '';
            data.geoLayers.forEach(l => {
                const div = document.createElement('div');
                div.className = `geo-layer-tag ${l.color}`;
                div.innerHTML = `<span>${l.name}</span> <i class="fas fa-layer-group opacity-50 text-[10px]"></i>`;
                layerList.appendChild(div);
            });

            const tbody = document.getElementById('control-points-body');
            tbody.innerHTML = '';
            const tableData = data.hasPreciseCoords ? data.controlPoints : data.alternativeTable;
            tableData.forEach(p => {
                const tr = document.createElement('tr');
                if(data.hasPreciseCoords) {
                     tr.innerHTML = `<td>${p.id}</td><td>${Number(p.x).toFixed(3)}</td><td>${Number(p.y).toFixed(3)}</td><td class="text-gray-400">${p.loc}</td>`;
                } else {
                     tr.innerHTML = `<td class="text-yellow-400">${p.type}</td><td colspan="2">${p.name}</td><td class="text-gray-400">${p.note}</td>`;
                }
                tbody.appendChild(tr);
            });

            const levelList = document.getElementById('level-points-list');
            levelList.innerHTML = '';
            data.levelPoints.forEach(p => {
                const div = document.createElement('div');
                div.className = 'bg-cyan-900/10 px-3 py-2 rounded border-l-2 border-cyan-500 text-xs text-cyan-200 flex justify-between items-center';
                div.innerHTML = `<span class="font-bold">${p.id}</span> <span>${p.h}</span>`;
                levelList.appendChild(div);
            });
        }

        function initClock() { setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('zh-CN', {hour12: false}), 1000); }
        window.addEventListener('resize', () => { if(map) map.invalidateSize(); });
        function goBackToGIS() { window.location.href = 'gis-platform.html'; }

    </script>
</body>
</html>
